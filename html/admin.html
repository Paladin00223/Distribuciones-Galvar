<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración - Distribuciones Galvar</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .admin-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .admin-titulo {
            font-size: 1.5rem;
            color: #333;
        }

        .btn-ir-tienda {
            padding: 0.75rem 1.5rem;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }

        .btn-ir-tienda:hover {
            background-color: #218838;
            transform: translateY(-2px);
        }

        .admin-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .admin-tab {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 4px;
            background-color: #f8f9fa;
            color: #495057;
            cursor: pointer;
            transition: all 0.2s;
        }

        .admin-tab.activo {
            background-color: #007bff;
            color: white;
        }

        .admin-tab:hover:not(.activo) {
            background-color: #e9ecef;
        }

        .admin-content {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 1.5rem;
        }

        .admin-table {
            width: 100%;
            border-collapse: collapse;
        }

        .admin-table th {
            background-color: #f8f9fa;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
        }

        .admin-table td {
            padding: 1rem;
            border-bottom: 1px solid #dee2e6;
            color: #6c757d;
        }

        .admin-table tr:last-child td {
            border-bottom: none;
        }

        .admin-table tr:hover {
            background-color: #f8f9fa;
        }

        .estado-pedido {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .estado-pendiente {
            background-color: #f39c12;
            color: white;
        }

        .estado-completado {
            background-color: #27ae60;
            color: white;
        }

        .estado-cancelado {
            background-color: #e74c3c;
            color: white;
        }

        .btn-accion {
            padding: 5px 10px;
            margin: 0 2px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-ver {
            background-color: #3498db;
            color: white;
        }

        .btn-editar {
            background-color: #2ecc71;
            color: white;
        }

        .btn-eliminar {
            background-color: #e74c3c;
            color: white;
        }

        .btn-accion:hover {
            opacity: 0.9;
        }

        .filtros {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .filtro-input {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            flex: 1;
        }

        .paginacion {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 2rem;
        }

        .btn-pagina {
            padding: 0.5rem 1rem;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            background-color: white;
            color: #495057;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-pagina:hover {
            background-color: #f8f9fa;
        }

        .btn-pagina.activo {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }

        .sin-registros {
            text-align: center;
            padding: 2rem;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <div class="admin-header">
            <h1 class="admin-titulo">Panel de Administración</h1>
            <a href="../index.html" class="btn-ir-tienda">
                <i class="fas fa-store"></i>
                Ir a la Tienda
            </a>
        </div>

        <div class="admin-tabs">
            <button class="admin-tab activo" data-tab="usuarios">Usuarios</button>
            <button class="admin-tab" data-tab="pedidos">Pedidos</button>
        </div>

        <div class="admin-content">
            <!-- Sección de Usuarios -->
            <div id="usuarios-content" class="tab-content">
                <div class="filtros">
                    <input type="text" class="filtro-input" placeholder="Buscar usuario por nombre, email o ID...">
                </div>
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Email</th>
                            <th>Cédula</th>
                            <th>Documento</th>
                            <th>Paquete</th>
                            <th>Puntos</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="usuarios-tabla">
                        <!-- Los usuarios se cargarán dinámicamente -->
                    </tbody>
                </table>
            </div>

            <!-- Sección de Pedidos -->
            <div id="pedidos-content" class="tab-content" style="display: none;">
                <div class="filtros">
                    <input type="text" id="buscarPedido" class="filtro-input" placeholder="Buscar pedido por ID o usuario...">
                    <select id="filtroEstado" class="filtro-input">
                        <option value="todos">Todos los estados</option>
                        <option value="Pendiente">Pendiente</option>
                        <option value="Procesado">Procesado</option>
                        <option value="Cancelado">Cancelado</option>
                    </select>
                </div>
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>ID Pedido</th>
                            <th>Usuario</th>
                            <th>Productos</th>
                            <th>Dirección de Envío</th>
                            <th>Monto</th>
                            <th>Fecha</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="pedidos-tabla">
                        <!-- Los pedidos se cargarán dinámicamente -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Verificación de acceso de administrador
        document.addEventListener('DOMContentLoaded', function() {
            const usuario = JSON.parse(localStorage.getItem('usuario'));
            if (!usuario || !usuario.esAdmin) {
                window.location.href = 'login.html';
                return;
            }

            // Mostrar nombre del administrador
            document.querySelector('.admin-titulo').textContent = `Panel de Administración - ${usuario.nombre}`;
            
            // Cargar pedidos al iniciar
            cargarPedidos();
            
            // Agregar event listeners para los filtros
            document.getElementById('buscarPedido').addEventListener('input', filtrarPedidos);
            document.getElementById('filtroEstado').addEventListener('change', filtrarPedidos);
        });

        // Función para cargar los pedidos
        function cargarPedidos() {
            const pedidos = JSON.parse(localStorage.getItem('historialCompras')) || [];
            mostrarPedidos(pedidos);
        }

        // Función para mostrar los pedidos en la tabla
        function mostrarPedidos(pedidos) {
            const tbody = document.getElementById('pedidos-tabla');
            tbody.innerHTML = pedidos.map(pedido => `
                <tr>
                    <td>${pedido.id}</td>
                    <td>${pedido.cliente.nombre}</td>
                    <td>
                        <button class="btn-accion btn-ver" onclick="verDetallesProductos('${pedido.id}')">
                            <i class="fas fa-box"></i> Ver productos
                        </button>
                    </td>
                    <td>${pedido.cliente.direccion}</td>
                    <td>$${pedido.total.toLocaleString('es-CO')}</td>
                    <td>${new Date(pedido.fecha).toLocaleDateString('es-CO')}</td>
                    <td>
                        <span class="estado-pedido ${obtenerClaseEstado(pedido.estado)}">
                            ${pedido.estado}
                        </span>
                    </td>
                    <td>
                        ${pedido.estado === 'Pendiente' ? `
                            <button class="btn-accion btn-editar" onclick="procesarPedido('${pedido.id}')">
                                <i class="fas fa-check"></i> Procesar
                            </button>
                            <button class="btn-accion btn-eliminar" onclick="cancelarPedido('${pedido.id}')">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                        ` : ''}
                        <button class="btn-accion btn-ver" onclick="verPedido('${pedido.id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Función para filtrar pedidos
        function filtrarPedidos() {
            const busqueda = document.getElementById('buscarPedido').value.toLowerCase();
            const estadoFiltro = document.getElementById('filtroEstado').value;
            const pedidos = JSON.parse(localStorage.getItem('historialCompras')) || [];
            
            const pedidosFiltrados = pedidos.filter(pedido => {
                const coincideBusqueda = pedido.id.toLowerCase().includes(busqueda) ||
                                       pedido.cliente.nombre.toLowerCase().includes(busqueda);
                const coincideEstado = estadoFiltro === 'todos' || pedido.estado === estadoFiltro;
                
                return coincideBusqueda && coincideEstado;
            });
            
            mostrarPedidos(pedidosFiltrados);
        }

        // Función para procesar un pedido
        function procesarPedido(idPedido) {
            const pedidos = JSON.parse(localStorage.getItem('historialCompras')) || [];
            const pedidoIndex = pedidos.findIndex(p => p.id === idPedido);
            
            if (pedidoIndex !== -1) {
                pedidos[pedidoIndex].estado = 'Procesado';
                localStorage.setItem('historialCompras', JSON.stringify(pedidos));
                cargarPedidos();
                alert('Pedido procesado exitosamente');
            }
        }

        // Función para cancelar un pedido
        function cancelarPedido(idPedido) {
            if (confirm('¿Está seguro de que desea cancelar este pedido?')) {
                const pedidos = JSON.parse(localStorage.getItem('historialCompras')) || [];
                const pedidoIndex = pedidos.findIndex(p => p.id === idPedido);
                
                if (pedidoIndex !== -1) {
                    pedidos[pedidoIndex].estado = 'Cancelado';
                    localStorage.setItem('historialCompras', JSON.stringify(pedidos));
                    cargarPedidos();
                    alert('Pedido cancelado exitosamente');
                }
            }
        }

        // Función para ver detalles de productos
        function verDetallesProductos(idPedido) {
            console.log('verDetallesProductos llamado con idPedido:', idPedido); // Debug log
            const pedidos = JSON.parse(localStorage.getItem('historialCompras')) || [];
            console.log('Historial de compras cargado:', pedidos); // Debug log
            const pedido = pedidos.find(p => p.id === idPedido);
            console.log('Pedido encontrado:', pedido); // Debug log
            
            if (pedido) {
                if (pedido.productos && Array.isArray(pedido.productos) && pedido.productos.length > 0) {
                    const detalles = pedido.productos.map(p =>
                        // Usar p.price en lugar de p.precio y verificar que sea un número
                        `${p.name} - Cantidad: ${p.quantity} - Precio: $${(typeof p.price === 'number' ? p.price.toLocaleString('es-CO') : 'N/A')}`
                    ).join('\n');

                    console.log('Detalles generados:', detalles); // Debug log
                    alert(`Detalles del pedido ${idPedido}:\n\n${detalles}`);
                } else {
                    console.warn('Pedido encontrado pero sin productos:', pedido); // Debug log
                    alert(`El pedido ${idPedido} no tiene productos registrados.`);
                }
            } else {
                console.error('Pedido no encontrado con ID:', idPedido); // Debug log
                alert(`No se encontró el pedido con ID ${idPedido}.`);
            }
        }


        // Función para ver detalles completos del pedido
        function verPedido(idPedido) {
            const pedidos = JSON.parse(localStorage.getItem('historialCompras')) || [];
            const pedido = pedidos.find(p => p.id === idPedido);
            
            if (pedido) {
                const detalles = `
                    ID: ${pedido.id}
                    Cliente: ${pedido.cliente.nombre}
                    Email: ${pedido.cliente.email}
                    Teléfono: ${pedido.cliente.telefono}
                    Dirección: ${pedido.cliente.direccion}
                    Fecha: ${new Date(pedido.fecha).toLocaleString('es-CO')}
                    Estado: ${pedido.estado}
                    Total: $${pedido.total.toLocaleString('es-CO')}
                    Puntos ganados: ${pedido.puntosGanados}
                `;
                
                alert(detalles);
            }
        }

        // Función para obtener la clase CSS según el estado
        function obtenerClaseEstado(estado) {
            switch(estado) {
                case 'Pendiente': return 'estado-pendiente';
                case 'Procesado': return 'estado-completado';
                case 'Cancelado': return 'estado-cancelado';
                default: return '';
            }
        }

        // Manejo de pestañas
        document.querySelectorAll('.admin-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                // Remover clase activo de todas las pestañas
                document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('activo'));
                // Agregar clase activo a la pestaña clickeada
                tab.classList.add('activo');

                // Ocultar todos los contenidos
                document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
                // Mostrar el contenido correspondiente
                document.getElementById(`${tab.dataset.tab}-content`).style.display = 'block';
            });
        });
    </script>
</body>
</html> 